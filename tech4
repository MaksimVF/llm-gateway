–ø—Ä–æ–≤–µ—Ä—å —Å–æ–∑–¥–∞–Ω–æ –ª–∏ –¥–≤–∞ —Ñ–∞–π–ª–∞ –¥–ª—è FastAPI-–ø—Ä–æ–µ–∫—Ç–∞ LLM Gateway:

---

üìÑ billing/token_tracker.py

–†–µ–∞–ª–∏–∑—É–π –∫–ª–∞—Å—Å `TokenTracker`, –∫–æ—Ç–æ—Ä—ã–π:

1. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Redis (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω) –∏ fallback –Ω–∞ —Å–ª–æ–≤–∞—Ä—å.
2. –•—Ä–∞–Ω–∏—Ç usage –ø–æ API-–∫–ª—é—á—É: `{"used_tokens": int, "last_updated": datetime}`
3. –ò–º–µ–µ—Ç –º–µ—Ç–æ–¥—ã:
   - `get_usage(api_key: str) -> int`
   - `increment_usage(api_key: str, tokens: int)`
   - `check_limit(api_key: str, max_tokens: int) -> bool`
   - `reset_monthly_usage()` ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç usage (–≤—ã–∑—ã–≤–∞—Ç—å —á–µ—Ä–µ–∑ cron)
4. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `redis-py` (`redis.Redis`) —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (`localhost:6379`)
5. –õ–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ —á–µ—Ä–µ–∑ `logging.warning`

---

üìÑ billing/tariffs.py

–°–æ–∑–¥–∞–π —Å–ª–æ–≤–∞—Ä—å `TARIFFS`, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ API-–∫–ª—é—á–∞:

```python
TARIFFS = {
    "demo-key-1": {"max_tokens": 100_000},
    "premium-key-2": {"max_tokens": 1_000_000},
    "free-user": {"max_tokens": 10_000}
}

–î–æ–ø–∏—à–∏ —Ñ–∞–π–ª `gateway/routes.py` –≤ –ø—Ä–æ–µ–∫—Ç–µ LLM Gateway:

1. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π:
```python
from billing.token_tracker import TokenTracker
from billing.tariffs import TARIFFS
from fastapi import HTTPException



2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π token_tracker = TokenTracker()


3. –í –æ—Å–Ω–æ–≤–Ω–æ–º —Ä–æ—É—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, /generate, /chat, /completion):

–ü–æ–ª—É—á–∏ API-–∫–ª—é—á –∏–∑ –∑–∞–ø—Ä–æ—Å–∞

–ü–æ–ª—É—á–∏ max_tokens –∏–∑ TARIFFS

–ü—Ä–æ–≤–µ—Ä—å, –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏ –ª–∏–º–∏—Ç —á–µ—Ä–µ–∑ token_tracker.check_limit(...)

–ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω ‚Äî –≤–µ—Ä–Ω–∏ HTTPException(status_code=429, detail="Token limit exceeded.")

–ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—É—á–∏ used_tokens –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (response["usage"]["total_tokens"])

–û–±–Ω–æ–≤–∏ usage: token_tracker.increment_usage(api_key, used_tokens)



4. –î–æ–±–∞–≤—å –Ω–æ–≤—ã–π endpoint:



@app.get("/usage")
def usage_info(api_key: str):
    max_tokens = TARIFFS.get(api_key, {}).get("max_tokens", 0)
    used_tokens = token_tracker.get_usage(api_key)
    return {"api_key": api_key, "used_tokens": used_tokens, "max_tokens": max_tokens}

5. –î–æ–±–∞–≤—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: –µ—Å–ª–∏ –ª–∏–º–∏—Ç –ø–æ—á—Ç–∏ –∏—Å—á–µ—Ä–ø–∞–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, >90%) ‚Äî –ª–æ–≥–∏—Ä—É–π –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ logging.warning(...)

