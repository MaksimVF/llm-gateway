# Система биллинга LLM Gateway

## Обзор

Система биллинга обеспечивает учёт использования токенов и контроль лимитов для API-ключей. Поддерживается дневной и месячный лимиты с возможностью установки индивидуальных ограничений для каждого ключа.

## Архитектура

### Модули

- **`billing/models.py`** - Модели данных SQLAlchemy для хранения статистики
- **`billing/tracker.py`** - Логирование использования токенов и получение статистики
- **`billing/limits.py`** - Проверка лимитов и управление ограничениями
- **`billing/__init__.py`** - Инициализация модуля

### База данных

Используется SQLite для хранения:
- **`api_key_usage`** - Статистика использования по дням
- **`api_key_limits`** - Индивидуальные лимиты для ключей

## Конфигурация

### Переменные окружения (.env)

```bash
# Глобальные лимиты (по умолчанию для всех ключей)
API_DAILY_LIMIT=50000
API_MONTHLY_LIMIT=1000000

# База данных
DATABASE_URL=sqlite:///./billing.db
```

## Функциональность

### 1. Автоматический учёт токенов

При каждом запросе к `/v1/completions`:
1. Проверяются лимиты перед выполнением запроса
2. Логируется фактическое использование токенов после ответа
3. При превышении лимитов возвращается ошибка 429

### 2. Типы лимитов

- **Дневной лимит** - сбрасывается каждый день в 00:00 UTC
- **Месячный лимит** - сбрасывается 1 числа каждого месяца

### 3. Индивидуальные лимиты

Можно установить персональные лимиты для любого API-ключа:

```python
from billing.limits import set_api_key_limits

# Установка индивидуальных лимитов
set_api_key_limits(
    api_key="sk-custom-key",
    daily_limit=10000,      # None для использования глобального
    monthly_limit=250000,   # None для использования глобального
    is_active=True          # False для блокировки ключа
)
```

## API эндпоинты

### GET /limits
Получение информации о лимитах для текущего API-ключа.

**Заголовки:**
```
Authorization: Bearer sk-your-api-key
```

**Ответ:**
```json
{
  "api_key": "sk-your-...",
  "daily": {
    "limit": 50000,
    "used": 1250,
    "remaining": 48750,
    "percentage_used": 2.5
  },
  "monthly": {
    "limit": 1000000,
    "used": 15000,
    "remaining": 985000,
    "percentage_used": 1.5
  }
}
```

### GET /usage
Получение детальной статистики использования.

**Заголовки:**
```
Authorization: Bearer sk-your-api-key
```

**Ответ:**
```json
{
  "usage": {
    "api_key": "sk-your-...",
    "period": {
      "start_date": "2025-05-15",
      "end_date": "2025-06-13",
      "days": 30
    },
    "total": {
      "tokens_used": 15000,
      "requests_count": 45,
      "avg_tokens_per_request": 333.33
    },
    "today": {
      "tokens_used": 1250,
      "requests_count": 4,
      "avg_tokens_per_request": 312.5
    },
    "current_month": {
      "tokens_used": 15000,
      "requests_count": 45,
      "avg_tokens_per_request": 333.33
    },
    "daily_breakdown": [
      {
        "date": "2025-06-13",
        "tokens_used": 1250,
        "requests_count": 4,
        "avg_tokens_per_request": 312.5
      }
    ]
  },
  "limits": { /* аналогично /limits */ }
}
```

## Обработка ошибок

### 429 Too Many Requests
Возвращается при превышении лимитов:

```json
{
  "detail": "Превышен дневной лимит токенов. Использовано: 50000, лимит: 50000"
}
```

**Заголовки ответа:**
```
Retry-After: 3600
```

## Подсчёт токенов

### Оценка токенов
Для проверки лимитов используется оценка:
- Входящие токены: `len(prompt) / 4`
- Общая оценка: `входящие + max_tokens`

### Фактический подсчёт
После получения ответа от LLM извлекается точное количество:
1. Из поля `usage.total_tokens` (OpenAI-совместимые API)
2. Из суммы `usage.prompt_tokens + usage.completion_tokens`
3. Оценка по длине ответа если данных нет

## Администрирование

### Тестирование системы
```bash
python test_billing.py
```

### Просмотр статистики
```python
from billing.tracker import get_system_stats, get_top_users

# Общая статистика системы
stats = get_system_stats(period_days=30)

# Топ пользователей
top = get_top_users(limit=10, period_days=30)
```

### Очистка старых данных
```python
from billing.tracker import cleanup_old_records

# Удаление записей старше 365 дней
deleted_count = cleanup_old_records(days_to_keep=365)
```

### Управление лимитами
```python
from billing.limits import set_api_key_limits, is_api_key_active

# Блокировка ключа
set_api_key_limits("sk-blocked-key", is_active=False)

# Проверка активности
active = is_api_key_active("sk-some-key")
```

## Мониторинг

### Логирование
Все операции биллинга логируются с уровнями:
- `INFO` - успешные операции
- `WARNING` - превышения лимитов
- `ERROR` - ошибки системы

### Метрики для мониторинга
- Общее использование токенов
- Количество заблокированных запросов
- Топ пользователей по потреблению
- Процент использования лимитов

## Расширение

Система спроектирована для легкого расширения:
- Добавление новых типов лимитов (почасовые, недельные)
- Интеграция с внешними системами биллинга
- Поддержка различных тарифных планов
- Уведомления о приближении к лимитам